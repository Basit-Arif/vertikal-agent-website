<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create New Story • Vertikal Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <style>
    body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
    .ql-toolbar.ql-snow { border-radius: 18px 18px 0 0; border: 1px solid rgba(148, 163, 184, 0.4); padding: 12px; }
    .ql-container.ql-snow { border-radius: 0 0 18px 18px; border: 1px solid rgba(148, 163, 184, 0.4); min-height: 320px; }
    .form-card { box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08); }
    /* Constrain images inserted into the editor to standard, responsive size */
    .ql-editor img {
      max-width: 100%;
      height: auto;
      max-height: 480px;
      object-fit: contain;
      display: block;
      margin: 1.25rem auto;
      border-radius: 0.75rem;
    }
  </style>
</head>
<body>
{% set current_post = post if post is defined else None %}
{% set is_edit = current_post is not none %}
{% set form_action = form_action if form_action is defined else url_for('admin.add_blog') %}
{% set submit_label = submit_label if submit_label is defined else ('Save changes' if is_edit else 'Publish story') %}
{% set page_heading = page_heading if page_heading is defined else ('Update Vertikal story' if is_edit else 'Draft a new Vertikal story') %}
{% set page_subheading = page_subheading if page_subheading is defined else ('Refresh your story, adjust the SEO polish, and keep the Vertikal voice sharp.' if is_edit else 'Craft a compelling update, equip it with the right cover, and polish the SEO before publishing.') %}
{% set back_url = back_url if back_url is defined else (url_for('admin.manage_blogs') if is_edit else url_for('admin.dashboard')) %}
{% set back_label = back_label if back_label is defined else ('Back to posts' if is_edit else 'Back to dashboard') %}
{% set title_value = title_value if title_value is defined else (current_post.title if is_edit else '') %}
{% set subtitle_value = subtitle_value if subtitle_value is defined else (current_post.subtitle if is_edit else '') %}
{% set cover_url_value = cover_url_value if cover_url_value is defined else (current_post.cover_image if is_edit else '') %}
{% set default_tags = (current_post.tags | map(attribute='name') | join(', ')) if is_edit else '' %}
{% set tag_value = tag_value if tag_value is defined else ((tag_list if (tag_list is defined and tag_list) else default_tags) if (default_tags or (tag_list is defined and tag_list)) else '') %}
{% set meta_title_value = meta_title_value if meta_title_value is defined else (current_post.meta_title if is_edit and current_post.meta_title else '') %}
{% set meta_description_value = meta_description_value if meta_description_value is defined else (current_post.meta_description if is_edit and current_post.meta_description else '') %}
{% set meta_keywords_value = meta_keywords_value if meta_keywords_value is defined else (current_post.meta_keywords if is_edit and current_post.meta_keywords else '') %}
{% set excerpt_value = excerpt_value if excerpt_value is defined else (current_post.excerpt if is_edit and current_post.excerpt else '') %}
{% set initial_content = initial_content if initial_content is defined else (current_post.content if is_edit else '') %}
{% set cover_label_default = ('Current: ' ~ current_post.cover_image) if is_edit and current_post.cover_image else 'None' %}
  <div class="min-h-screen">
    <header class="border-b border-slate-200/60 bg-white">
      <div class="max-w-5xl px-6 py-6 mx-auto flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-sm font-semibold uppercase tracking-[0.28em] text-blue-600">Writer Studio</p>
          <h1 class="mt-2 text-3xl font-semibold text-slate-900">{{ page_heading }}</h1>
          <p class="text-sm text-slate-500">{{ page_subheading }}</p>
        </div>
        <a href="{{ back_url }}" class="inline-flex items-center justify-center rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-blue-500 hover:text-blue-600">{{ back_label }}</a>
      </div>
    </header>

    <main class="max-w-5xl px-6 mx-auto my-10">
      <form id="blog-form" method="POST" action="{{ form_action }}" enctype="multipart/form-data" class="space-y-10">
        <section class="form-card rounded-3xl border border-slate-200/70 bg-white p-8 sm:p-10">
          <h2 class="text-xl font-semibold text-slate-900">Story essentials</h2>
          <p class="mt-2 text-sm text-slate-500">Set the headline, subhead, and any cover image to set the tone.</p>

          <div class="grid gap-6 mt-8 sm:grid-cols-2">
            <div class="sm:col-span-2">
              <label for="title" class="block text-sm font-medium text-slate-600">Title *</label>
              <input
                id="title"
                name="title"
                type="text"
                required
                placeholder="Write a headline that grabs attention"
                value="{{ title_value }}"
                class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
              >
            </div>
            <div class="sm:col-span-2">
              <label for="subtitle" class="block text-sm font-medium text-slate-600">Subtitle</label>
              <input
                id="subtitle"
                name="subtitle"
                type="text"
                placeholder="Add a short hook to expand on your title"
                value="{{ subtitle_value }}"
                class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
              >
            </div>
            <div>
              <label for="cover_image" class="block text-sm font-medium text-slate-600">Cover image URL</label>
              <input
                id="cover_image"
                name="cover_image"
                type="url"
                placeholder="https://images.vertikalagent.com/cover.jpg"
                value="{{ cover_url_value }}"
                class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
              >
              {% if is_edit %}
                <p class="mt-2 text-xs text-slate-400">Leave this blank and skip uploading to remove the current cover.</p>
              {% endif %}
            </div>
            <div>
              <label for="cover_upload" class="block text-sm font-medium text-slate-600">Or upload a cover</label>
              <label
                for="cover_upload"
                class="mt-2 flex cursor-pointer flex-col items-center justify-center rounded-2xl border-2 border-dashed border-slate-300 px-6 py-6 text-center transition hover:border-blue-500 hover:bg-slate-50"
              >
                <span class="text-sm font-semibold text-slate-700">Drop an image, or click to browse</span>
                <span class="mt-2 text-xs text-slate-400">We accept PNG, JPG, GIF, or WEBP up to 2 MB.</span>
                <input id="cover_upload" name="cover_upload" type="file" accept="image/*" class="sr-only">
              </label>
              <p class="mt-2 text-xs text-slate-400">
                Selected file: <span id="cover-upload-name" class="font-medium text-slate-600" data-default="{{ cover_label_default }}">{{ cover_label_default }}</span>
                {% if is_edit and post.cover_image %}
                  <span class="ml-1 text-slate-400">(keeping current cover unless replaced)</span>
                {% endif %}
              </p>
            </div>
            <div>
              <label for="tags" class="block text-sm font-medium text-slate-600">Tags</label>
              <input
                id="tags"
                name="tags"
                type="text"
                placeholder="AI, Automation, Growth"
                value="{{ tag_value }}"
                class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
              >
              <p class="mt-2 text-xs text-slate-400">Separate tags with commas. They help group related stories for readers.</p>
            </div>
          </div>
        </section>

        <section class="form-card rounded-3xl border border-slate-200/70 bg-white p-8 sm:p-10">
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 class="text-xl font-semibold text-slate-900">Story body</h2>
              <p class="text-sm text-slate-500">Write your narrative, add visuals, and layer in insight. We’ll count words to help you hit the sweet spot.</p>
            </div>
            <div class="rounded-full bg-slate-100 px-4 py-2 text-sm font-medium text-slate-600">Word count: <span id="word-count" class="font-semibold text-blue-600">0</span></div>
          </div>
          <div class="mt-6">
            <div id="editor" class="rounded-3xl"></div>
            <input type="hidden" name="content" id="content">
          </div>
        </section>

        <section class="form-card rounded-3xl border border-slate-200/70 bg-white p-8 sm:p-10">
          <h2 class="text-xl font-semibold text-slate-900">SEO polish</h2>
          <p class="mt-2 text-sm text-slate-500">Tailor how this story appears on search, social, and link previews.</p>

          <div class="grid gap-6 mt-8 sm:grid-cols-2">
            <div>
              <label for="meta_title" class="block text-sm font-medium text-slate-600">Meta title</label>
              <input
                id="meta_title"
                name="meta_title"
                type="text"
                placeholder="Headline for search results (under 60 characters)"
                value="{{ meta_title_value }}"
                class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
              >
              <p class="mt-2 text-xs text-slate-400"><span id="meta-title-count">0</span>/60 characters</p>
            </div>
            <div>
              <label for="meta_keywords" class="block text-sm font-medium text-slate-600">Meta keywords</label>
              <input
                id="meta_keywords"
                name="meta_keywords"
                type="text"
                placeholder="automation, ai agents, vertikal"
                value="{{ meta_keywords_value if meta_keywords_value is defined else (current_post.meta_keywords if is_edit and current_post.meta_keywords else '') }}"
                class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
              >
              <p class="mt-2 text-xs text-slate-400">Optional: comma separated keywords for reference.</p>
            </div>
            <div class="sm:col-span-2">
              <label for="meta_description" class="block text-sm font-medium text-slate-600">Meta description</label>
              <textarea
                id="meta_description"
                name="meta_description"
                rows="3"
                placeholder="One or two sentences (under 160 characters) describing the big takeaway."
                class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
              >{{ meta_description_value }}</textarea>
              <p class="mt-2 text-xs text-slate-400"><span id="meta-description-count">0</span>/160 characters</p>
            </div>
            <div class="sm:col-span-2">
              <label for="excerpt" class="block text-sm font-medium text-slate-600">Newsletter excerpt</label>
              <textarea
                id="excerpt"
                name="excerpt"
                rows="3"
                placeholder="Write a short teaser (we use this for cards and social previews)."
                class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
              >{{ excerpt_value }}</textarea>
              <p class="mt-2 text-xs text-slate-400"><span id="excerpt-count">0</span>/200 characters</p>
            </div>
          </div>
        </section>

        <section class="form-card rounded-3xl border border-slate-200/70 bg-white p-8 sm:p-10">
          <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 class="text-xl font-semibold text-slate-900">Ready to publish?</h2>
              <p class="mt-2 text-sm text-slate-500">We’ll save and ship this story live as soon as you hit {{ submit_label|lower }}.</p>
            </div>
            <button
              type="submit"
              class="inline-flex items-center justify-center rounded-full bg-blue-600 px-8 py-3 text-sm font-semibold text-white shadow-lg shadow-blue-200 transition hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300"
            >
              {{ submit_label }}
            </button>
          </div>
        </section>
      </form>
    </main>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const uploadImageUrl = {{ url_for('admin.upload_blog_image') | tojson }};
    const toolbarOptions = [
      [{ header: [1, 2, 3, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      [{ list: 'ordered' }, { list: 'bullet' }],
      ['link', 'image', 'blockquote', 'code-block'],
      [{ align: [] }],
      ['clean'],
    ];

    function imageHandler() {
      const fileInput = document.createElement('input');
      fileInput.setAttribute('type', 'file');
      fileInput.setAttribute('accept', 'image/*');
      fileInput.onchange = async () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        const form = new FormData();
        form.append('image', file);
        const titleInput = document.getElementById('title');
        if (titleInput && titleInput.value) {
          form.append('context_title', titleInput.value);
        }
        try {
          const res = await fetch(uploadImageUrl, { method: 'POST', body: form });
          if (!res.ok) throw new Error('Upload failed');
          const data = await res.json();
          if (!data.url) throw new Error('No URL returned');
          const range = quill.getSelection(true);
          quill.insertEmbed(range ? range.index : 0, 'image', data.url, 'user');
          quill.setSelection((range ? range.index : 0) + 1, 0);
        } catch (err) {
          alert('Image upload failed. Please try a different image.');
        }
      };
      fileInput.click();
    }

    const quill = new Quill('#editor', {
      theme: 'snow',
      placeholder: 'Start drafting your story...',
      modules: {
        toolbar: {
          container: toolbarOptions,
          handlers: { image: imageHandler },
        },
      },
    });

    // Markdown paste support: detect Markdown in clipboard and convert to rich text
    quill.root.addEventListener('paste', (event) => {
      const data = event.clipboardData || window.clipboardData;
      if (!data) return;
      const markdown = data.getData('text/markdown') || data.getData('text/plain');
      if (!markdown) return;
      // Heuristic to detect markdown content
      const looksLikeMarkdown = /(^|\n)\s{0,3}#{1,6}\s|(^|\n)[-*+]\s+|(^|\n)\d+\.\s+|`{1,3}[\s\S]*?`{1,3}|\*\*[^*]+\*\*|__[^_]+__|!\[[^\]]*\]\([^)]+\)|\[[^\]]+\]\([^)]+\)/.test(markdown);
      if (!looksLikeMarkdown) return;
      event.preventDefault();
      try {
        const html = marked.parse(markdown, { breaks: true });
        const range = quill.getSelection(true);
        const index = range ? range.index : quill.getLength();
        quill.clipboard.dangerouslyPasteHTML(index, html, 'user');
        quill.setSelection(index + 1, 0);
      } catch (e) {
        // fallback to default behavior on failure
      }
    });

    const form = document.getElementById('blog-form');
    const hiddenContent = document.getElementById('content');
    const wordCountDisplay = document.getElementById('word-count');

    const titleInput = document.getElementById('title');
    const metaTitleInput = document.getElementById('meta_title');
    const metaDescriptionInput = document.getElementById('meta_description');
    const excerptInput = document.getElementById('excerpt');
    const coverUploadInput = document.getElementById('cover_upload');
    const coverUploadName = document.getElementById('cover-upload-name');

    const metaTitleCount = document.getElementById('meta-title-count');
    const metaDescriptionCount = document.getElementById('meta-description-count');
    const excerptCount = document.getElementById('excerpt-count');
    const initialContent = {{ initial_content | default('', true) | tojson }};
    const initialMetaTitle = {{ meta_title_value | default('', true) | tojson }};
    const initialMetaDescription = {{ meta_description_value | default('', true) | tojson }};
    const initialExcerpt = {{ excerpt_value | default('', true) | tojson }};
    const coverLabelDefault = coverUploadName ? coverUploadName.dataset.default : 'None';

    if (initialContent) {
      quill.root.innerHTML = initialContent;
    }

    if (coverUploadName) {
      coverUploadName.textContent = coverLabelDefault || 'None';
    }

    if (metaTitleInput && !metaTitleInput.value && initialMetaTitle) {
      metaTitleInput.value = initialMetaTitle;
    }
    if (metaDescriptionInput && !metaDescriptionInput.value && initialMetaDescription) {
      metaDescriptionInput.value = initialMetaDescription;
    }
    if (excerptInput && !excerptInput.value && initialExcerpt) {
      excerptInput.value = initialExcerpt;
    }

    let metaTitleTouched = Boolean(metaTitleInput && metaTitleInput.value);

    function countWords(text) {
      const trimmed = text.trim();
      if (!trimmed) return 0;
      return trimmed.split(/\s+/).length;
    }

    function updateWordCount() {
      const text = quill.getText();
      wordCountDisplay.textContent = countWords(text);
    }

    function bindCharacterCount(input, counterEl, limit) {
      const update = () => {
        const value = input.value || '';
        counterEl.textContent = value.length;
        if (limit && value.length > limit) {
          counterEl.classList.add('text-red-500');
        } else {
          counterEl.classList.remove('text-red-500');
        }
      };
      input.addEventListener('input', update);
      update();
    }

    quill.on('text-change', updateWordCount);
    updateWordCount();

    titleInput.addEventListener('input', () => {
      if (!metaTitleTouched) {
        metaTitleInput.value = titleInput.value.trim().slice(0, 60);
      }
      metaTitleCount.textContent = metaTitleInput.value.length;
    });

    metaTitleInput.addEventListener('input', () => {
      metaTitleTouched = true;
      metaTitleCount.textContent = metaTitleInput.value.length;
    });

    bindCharacterCount(metaDescriptionInput, metaDescriptionCount, 160);
    bindCharacterCount(excerptInput, excerptCount, 200);
    bindCharacterCount(metaTitleInput, metaTitleCount, 60);

    if (coverUploadInput) {
      coverUploadInput.addEventListener('change', () => {
        if (coverUploadInput.files && coverUploadInput.files.length > 0) {
          coverUploadName.textContent = coverUploadInput.files[0].name;
        } else {
          coverUploadName.textContent = coverLabelDefault || 'None';
        }
      });
    }

    form.addEventListener('submit', (event) => {
      const html = quill.root.innerHTML.trim();
      if (!html || quill.getText().trim().length === 0) {
        event.preventDefault();
        alert('Please add content to your story before publishing.');
        return;
      }
      hiddenContent.value = html;
    });
  </script>
</body>
</html>
